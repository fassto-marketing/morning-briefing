import google.generativeai as genai
import datetime
import os 

GOOGLE_API_KEY = os.environ.get("GOOGLE_API_KEY")

if GOOGLE_API_KEY:
    genai.configure(api_key=GOOGLE_API_KEY)

def analyze_for_leadership(all_articles):
    if not GOOGLE_API_KEY:
        return "ğŸš¨ API Key ì˜¤ë¥˜", "ì˜¤ë¥˜"

    news_text_dump = ""
    for idx, item in enumerate(all_articles, 1):
        news_text_dump += f"ê¸°ì‚¬{idx}: ì œëª©='{item['title']}', ë§í¬='{item['link']}'\n"

    utc_now = datetime.datetime.utcnow()
    kst_now = utc_now + datetime.timedelta(hours=9)
    today = kst_now.strftime("%Y-%m-%d")
    weekday = kst_now.strftime("%A")

    # 3. ë‚ ì¹´ë¡œìš´ ê²½ì˜ ë¶„ì„ê°€ í”„ë¡¬í”„íŠ¸
    prompt = f"""
    ë‹¹ì‹ ì€ íŒŒìŠ¤í† (Fassto)ì˜ ìµœê³  ì „ëµ ì±…ì„ì(CSO)ì…ë‹ˆë‹¤.
    ê²½ì˜ì§„ì´ ì‹œì¥ì˜ ìœ„í˜‘ê³¼ ê¸°íšŒë¥¼ ì¦‰ê°ì ìœ¼ë¡œ íŒŒì•…í•  ìˆ˜ ìˆë„ë¡, ê°€ì¥ íŒŒê¸‰ë ¥ì´ í° ë‰´ìŠ¤ 5ê°œë¥¼ ì—„ì„ í•˜ì—¬ ë‚ ì¹´ë¡­ê²Œ ë¸Œë¦¬í•‘í•˜ì„¸ìš”.

    [ì…ë ¥ëœ ë‰´ìŠ¤ ë°ì´í„°]
    {news_text_dump}

    [ì‘ì„± ì›ì¹™ - ì—„ê²© ì¤€ìˆ˜]
    1. ë‘ë£¨ë­‰ìˆ í•œ í‘œí˜„(ì˜ˆ: "ì¤‘ìš”í•´ì§", "ë…¸ë ¥í•´ì•¼ í•¨", "ê³ ë„í™” ì¤‘")ì„ ì² ì €íˆ ë°°ì œí•˜ì„¸ìš”.
    2. ìˆ«ì, ê³ ìœ ëª…ì‚¬(ê²½ìŸì‚¬ ì´ë¦„ ë“±), êµ¬ì²´ì  íŒ©íŠ¸ë¥¼ ë°˜ë“œì‹œ í¬í•¨í•˜ì„¸ìš”.
    3. ì´ ë‰´ìŠ¤ê°€ íŒŒìŠ¤í† ì˜ 'ë§¤ì¶œ', 'ê²½ìŸë ¥', 'ê³ ê° ì´íƒˆ'ì— ë¯¸ì¹˜ëŠ” ì§ì ‘ì ì¸ ì˜í–¥(Impact)ì„ ì œì‹œí•˜ì„¸ìš”.
    4. Action Itemì€ ë»”í•œ ë§(ì˜ˆ: "ë™í–¥ íŒŒì•…") ëŒ€ì‹ , ì¦‰ì‹œ ì§€ì‹œí•  ìˆ˜ ìˆëŠ” êµ¬ì²´ì ì¸ í–‰ë™(ì˜ˆ: "ì œì£¼ë„ ìµì¼ë°°ì†¡ ëŒ€ì‘ì„ ìœ„í•œ í˜„ì§€ íŒŒíŠ¸ë„ˆì‚¬ ë‹¨ê°€ ë¹„êµ")ìœ¼ë¡œ ì‘ì„±í•˜ì„¸ìš”.
    5. ì•„ë˜ [ì¶œë ¥ í…œí”Œë¦¿] ê¸°í˜¸ì™€ í˜•íƒœë¥¼ 100% ë˜‘ê°™ì´ ìœ ì§€í•˜ì„¸ìš”. (ì¸ì‚¬ë§ ë“± ì ˆëŒ€ ê¸ˆì§€)

    [ì¶œë ¥ í…œí”Œë¦¿]
    ğŸ›ï¸ {today} ëª¨ë‹ ë¸Œë¦¬í•‘ ({weekday})

    ğŸ“Š Market Watch

    1. <ë§í¬ì£¼ì†Œ|ê¸°ì‚¬ì œëª©>
    > [Fact] í•µì‹¬ íŒ©íŠ¸ 1ì¤„ ìš”ì•½ (ìˆ˜ì¹˜/ê¸°ì—…ëª… í¬í•¨)
    > [Impact] íŒŒìŠ¤í†  ë¹„ì¦ˆë‹ˆìŠ¤ì— ë¯¸ì¹˜ëŠ” íƒ€ê²©/ê¸°íšŒ ìš”ì†Œ 1ì¤„ ìš”ì•½
    > ğŸ·ï¸ #íƒœê·¸1 #íƒœê·¸2 #íƒœê·¸3

    2. <ë§í¬ì£¼ì†Œ|ê¸°ì‚¬ì œëª©>
    > [Fact] í•µì‹¬ íŒ©íŠ¸ 1ì¤„ ìš”ì•½
    > [Impact] íŒŒìŠ¤í†  ë¹„ì¦ˆë‹ˆìŠ¤ì— ë¯¸ì¹˜ëŠ” íƒ€ê²©/ê¸°íšŒ ìš”ì†Œ 1ì¤„ ìš”ì•½
    > ğŸ·ï¸ #íƒœê·¸1 #íƒœê·¸2 #íƒœê·¸3

    3. <ë§í¬ì£¼ì†Œ|ê¸°ì‚¬ì œëª©>
    > [Fact] í•µì‹¬ íŒ©íŠ¸ 1ì¤„ ìš”ì•½
    > [Impact] íŒŒìŠ¤í†  ë¹„ì¦ˆë‹ˆìŠ¤ì— ë¯¸ì¹˜ëŠ” íƒ€ê²©/ê¸°íšŒ ìš”ì†Œ 1ì¤„ ìš”ì•½
    > ğŸ·ï¸ #íƒœê·¸1 #íƒœê·¸2 #íƒœê·¸3

    4. <ë§í¬ì£¼ì†Œ|ê¸°ì‚¬ì œëª©>
    > [Fact] í•µì‹¬ íŒ©íŠ¸ 1ì¤„ ìš”ì•½
    > [Impact] íŒŒìŠ¤í†  ë¹„ì¦ˆë‹ˆìŠ¤ì— ë¯¸ì¹˜ëŠ” íƒ€ê²©/ê¸°íšŒ ìš”ì†Œ 1ì¤„ ìš”ì•½
    > ğŸ·ï¸ #íƒœê·¸1 #íƒœê·¸2 #íƒœê·¸3

    5. <ë§í¬ì£¼ì†Œ|ê¸°ì‚¬ì œëª©>
    > [Fact] í•µì‹¬ íŒ©íŠ¸ 1ì¤„ ìš”ì•½
    > [Impact] íŒŒìŠ¤í†  ë¹„ì¦ˆë‹ˆìŠ¤ì— ë¯¸ì¹˜ëŠ” íƒ€ê²©/ê¸°íšŒ ìš”ì†Œ 1ì¤„ ìš”ì•½
    > ğŸ·ï¸ #íƒœê·¸1 #íƒœê·¸2 #íƒœê·¸3

    ğŸ”­ Executive Summary
    * ì‹œì¥ íë¦„ì„ ê´€í†µí•˜ëŠ” í†µì°°ë ¥ ìˆëŠ” ê²°ë¡  ë° íŒŒìŠ¤í† ê°€ ì¦‰ì‹œ ì·¨í•´ì•¼ í•  í•µì‹¬ ì „ëµ ë°©í–¥ 2~3ì¤„
    ===SPLIT===
    âš¡ ë¶€ì„œë³„ Action Item
    * ğŸ’¼ Sales: êµ¬ì²´ì ì¸ ê³ ê° ë°©ì–´/ì‹ ê·œ íƒ€ê²ŸíŒ… ì§€ì‹œ 1ì¤„
    * ğŸ’» Tech: ë‹¹ì‚¬ IT ê²½ìŸë ¥ í™•ë³´ë¥¼ ìœ„í•œ êµ¬ì²´ì  ì ê²€ ì§€ì‹œ 1ì¤„
    * ğŸ‘¥ HR: ë…¸ë¬´ ë¦¬ìŠ¤í¬ ë°©ì–´ ë˜ëŠ” í•„ìˆ˜ ì¸ì¬ í™•ë³´ ì§€ì‹œ 1ì¤„
    * ğŸ’° Finance: íˆ¬ì/ë¹„ìš© ê´€ì ì˜ ëŒ€ì‘ ì§€ì‹œ 1ì¤„
    * ğŸš› SCM: í˜„ì¥ ìš´ì˜ ë° ë¬¼ë¥˜ ë‹¨ê°€ ë°©ì–´ë¥¼ ìœ„í•œ ì§€ì‹œ 1ì¤„
    """

    try:
        model = genai.GenerativeModel("gemini-2.5-flash") 
        # temperatureë¥¼ 0.4ë¡œ ì£¼ì–´ ì•½ê°„ì˜ í†µì°°ë ¥ì„ ë°œíœ˜í•˜ë©´ì„œë„ í¬ë§·ì„ ì§€í‚¤ê²Œ í•¨
        response = model.generate_content(prompt, generation_config={"temperature": 0.4}) 
        full_text = response.text.replace("**", "*")
        
        full_text = full_text.replace("---", "").strip()
        
        if "===SPLIT===" in full_text:
            parts = full_text.split("===SPLIT===")
            summary_message = parts[0].strip()
            detail_message = parts[1].strip()
            
            if summary_message.startswith("*"): summary_message = summary_message[1:].strip()
            if detail_message.startswith("*"): detail_message = detail_message[1:].strip()
            
            return summary_message, detail_message
        else:
            return full_text, "ìƒì„¸ ë‚´ìš© ìƒì„± ì‹¤íŒ¨"
        
    except Exception as e:
        return f"ğŸš¨ ì—ëŸ¬: {e}", "ì—ëŸ¬ ë°œìƒ"
