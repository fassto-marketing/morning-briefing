import google.generativeai as genai
import datetime
import os 

GOOGLE_API_KEY = os.environ.get("GOOGLE_API_KEY")

if GOOGLE_API_KEY:
    genai.configure(api_key=GOOGLE_API_KEY)

def analyze_for_leadership(all_articles):
    if not GOOGLE_API_KEY:
        return "ğŸš¨ API Key ì˜¤ë¥˜", "ì˜¤ë¥˜"

    # 1. ë‰´ìŠ¤ ë°ì´í„° ì •ë¦¬
    news_text_dump = ""
    for idx, item in enumerate(all_articles, 1):
        # AIê°€ ë§í¬ë¥¼ ì •í™•íˆ ë§¤ì¹­í•˜ë„ë¡ ëª…í™•í•˜ê²Œ ì „ë‹¬
        news_text_dump += f"ê¸°ì‚¬{idx}: ì œëª©='{item['title']}', ë§í¬='{item['link']}'\n"

    # 2. í•œêµ­ ì‹œê°„ ê³„ì‚°
    utc_now = datetime.datetime.utcnow()
    kst_now = utc_now + datetime.timedelta(hours=9)
    today = kst_now.strftime("%Y-%m-%d")
    weekday = kst_now.strftime("%A")

    # 3. ë‰´ìŠ¤ë ˆí„° ìŠ¤íƒ€ì¼ í”„ë¡¬í”„íŠ¸
    prompt = f"""
    ë‹¹ì‹ ì€ íŒŒìŠ¤í† (Fassto) ê²½ì˜ì§„ì„ ìœ„í•œ **'Daily Intelligence Officer'**ì…ë‹ˆë‹¤.
    ì œê³µëœ ë‰´ìŠ¤ ì¤‘ **ê°€ì¥ ì¤‘ìš”í•œ 5ê°œ**ë¥¼ ì—„ì„ í•˜ì—¬, ê²½ì˜ì§„ì´ 1ë¶„ ì•ˆì— ì½ì„ ìˆ˜ ìˆëŠ” **'ë‰´ìŠ¤ë ˆí„° ìŠ¤íƒ€ì¼'**ë¡œ ë¸Œë¦¬í•‘í•˜ì„¸ìš”.

    [ì…ë ¥ëœ ë‰´ìŠ¤ ë°ì´í„°]
    {news_text_dump}

    ------------------------------------------------------------------
    **[ì‘ì„± ì›ì¹™ - ì¤‘ìš”]**
    1. **ê°€ë…ì„± 1ìˆœìœ„:** ì´ë¯¸ì§€3ì²˜ëŸ¼ ê¹”ë”í•˜ê²Œ ì •ë¦¬í•˜ì„¸ìš”. êµ°ë”ë”ê¸° ì„œìˆ ì–´(~í•¨, ~ì„)ë¥¼ ë°°ì œí•˜ì„¸ìš”.
    2. **ë§í¬ í¬ë§· ì¤€ìˆ˜:** ìŠ¬ë™ í•˜ì´í¼ë§í¬ í¬ë§·ì¸ `<ë§í¬ì£¼ì†Œ|ë‰´ìŠ¤ì œëª©>` í˜•ì‹ì„ ë°˜ë“œì‹œ ì§€í‚¤ì„¸ìš”. URLì„ ë³„ë„ë¡œ ë…¸ì¶œí•˜ì§€ ë§ˆì„¸ìš”.
    3. **íŒ©íŠ¸ ì¤‘ì‹¬:** AIì˜ ì£¼ê´€ì  í•´ì„ë³´ë‹¤ëŠ” 'ê¸°ì‚¬ ë‚´ìš©ì˜ í•µì‹¬ íŒ©íŠ¸'ë¥¼ 2ì¤„ ì´ë‚´ë¡œ ìš”ì•½í•˜ì„¸ìš”.

    ------------------------------------------------------------------
    **[ì¶œë ¥ íŒŒíŠ¸ 1: ğŸ›ï¸ ê²½ì˜ì§„ ëª¨ë‹ ë¸Œë¦¬í•‘]**

    **ğŸ“Š Market Watch ({today} {weekday})**
    (ë‰´ìŠ¤ 5ê°œë¥¼ ì•„ë˜ í¬ë§·ìœ¼ë¡œ ì‘ì„±)

    1. <ë§í¬|ê¸°ì‚¬ì œëª©ì„_ì—¬ê¸°ì—_ì ìœ¼ì„¸ìš”>
    > (í•µì‹¬ íŒ©íŠ¸ 1~2ì¤„ ìš”ì•½)
    > ğŸ·ï¸ #ê´€ë ¨ê¸°ì—… #í‚¤ì›Œë“œ #ì´ìŠˆ

    2. <ë§í¬|ê¸°ì‚¬ì œëª©...>
    > (ë‚´ìš©...)
    > ğŸ·ï¸ ...

    (5ë²ˆê¹Œì§€ ì‘ì„± í›„)

    **ğŸ”­ Executive Summary**
    * (ìœ„ ë‰´ìŠ¤ë“¤ì„ ê´€í†µí•˜ëŠ” ì‹œì¥ì˜ í•µì‹¬ íë¦„ì„ 3ì¤„ ì´ë‚´ë¡œ í†µì°°ë ¥ ìˆê²Œ ìš”ì•½)

    ------------------------------------------------------------------
    **===SPLIT===**
    ------------------------------------------------------------------

    **[ì¶œë ¥ íŒŒíŠ¸ 2: ë¶€ì„œë³„ Action Item (ìŠ¤ë ˆë“œìš©)]**
    ê° ë¶€ì„œ ë¦¬ë”ê°€ ì²´í¬í•´ì•¼ í•  ì‚¬í•­ì„ **ë‹¨í˜¸í•˜ê³  ëª…í™•í•œ ì–´ì¡°**ë¡œ ì§€ì‹œí•˜ì„¸ìš”.

    * **ğŸ’¼ Sales:** (ê²½ìŸì‚¬ ë™í–¥ì— ë”°ë¥¸ ì˜ì—… í¬ì¸íŠ¸)
    * **ğŸ’» Tech:** (ê¸°ìˆ  íŠ¸ë Œë“œ/ë³´ì•ˆ ì´ìŠˆ ì ê²€)
    * **ğŸ‘¥ HR:** (ì±„ìš©/ì¡°ì§ë¬¸í™” ë¦¬ìŠ¤í¬)
    * **ğŸ’° Finance:** (íˆ¬ì/ë¹„ìš© ì´ìŠˆ)
    * **ğŸš› SCM:** (ìš´ì˜/ë¬¼ë¥˜ í˜„ì¥ ì´ìŠˆ)
    """

    try:
        model = genai.GenerativeModel("gemini-2.5-flash") 
        response = model.generate_content(prompt, generation_config={"temperature": 0.5}) # ì˜¨ë„ë¥¼ ë‚®ì¶°ì„œ(0.5) ë” ì°¨ë¶„í•˜ê³  ì •í™•í•˜ê²Œ
        full_text = response.text.replace("**", "*") # ìŠ¬ë™ ë³¼ë“œì²´ í˜¸í™˜
        
        if "===SPLIT===" in full_text:
            parts = full_text.split("===SPLIT===")
            summary_message = parts[0].strip()
            detail_message = parts[1].strip()
            return summary_message, detail_message
        else:
            return full_text, "ìƒì„¸ ë‚´ìš© ìƒì„± ì‹¤íŒ¨"
        
    except Exception as e:
        return f"ğŸš¨ ì—ëŸ¬: {e}", "ì—ëŸ¬ ë°œìƒ"
